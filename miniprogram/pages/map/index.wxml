<!-- 地图容器 -->
<view class="map-container">
  <map 
    id="idiomMap" 
    class="map" 
    latitude="{{latitude}}"
    longitude="{{longitude}}"
    scale="{{scale}}"
    markers="{{markers}}"
    show-location
    bindmarkertap="onMarkerTap"
  >
    <cover-view class="controls-container">
      <cover-view class="control-item" bindtap="moveToHandan">
        <cover-image src="/images/location-icon.png" class="control-icon"></cover-image>
        <cover-text>定位邯郸</cover-text>
      </cover-view>
    </cover-view>
  </map>
  <view wx:if="{{showPopup}}" class="popup-mask" bindtap="closePopup">
    <view class="popup-swiper-container">
      <swiper 
        class="idiom-swiper"
        current="{{currentIdiomIndex}}" 
        bindchange="onSwiperChange"
        circular="{{false}}"
        duration="300"
        bindtouchstart="onSwiperTouchStart"
        bindtouchmove="onSwiperTouchMove"
        bindtouchend="onSwiperTouchEnd"
      >
        <block wx:for="{{currentIdioms}}" wx:key="index">
          <swiper-item>
            <view class="popup-content" catchtap="stopPropagation">
              <!-- 弹窗头部 -->
              <view class="popup-header">
                <text class="idiom-title">{{item.name || '成语详情'}}</text>
                <view class="header-indicator">
                  <text class="indicator-text">{{currentIdiomIndex + 1}}/{{currentIdioms.length}}</text>
                  <view class="indicator-dots">
                    <block wx:for="{{currentIdioms}}" wx:key="index">
                      <view class="dot {{index === currentIdiomIndex ? 'active' : ''}}"></view>
                    </block>
                  </view>
                </view>
                <text class="close-btn" bindtap="closePopup">×</text>
              </view>
              
              <!-- 图片轮播区域 -->
              <view class="image-carousel" wx:if="{{item.images && item.images.length}}">
                <swiper 
                  class="image-swiper" 
                  current="{{currentImageIndex}}" 
                  bindchange="onImageSwiperChange"
                  circular="{{true}}"
                  autoplay="{{true}}"
                  interval="3000"
                  duration="300"
                >
                  <block wx:for="{{item.images}}" wx:key="index">
                    <swiper-item>
                      <image class="carousel-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}"></image>
                    </swiper-item>
                  </block>
                </swiper>
                <view class="image-indicator" wx:if="{{item.images.length > 1}}">
                  <text class="image-indicator-text">{{currentImageIndex + 1}}/{{item.images.length}}</text>
                </view>
              </view>

              <!-- 内容区域 - 可上下滚动 -->
              <scroll-view 
                class="popup-body" 
                scroll-y 
                enhanced
                id="scroll-{{index}}"
                bindtouchstart="onScrollTouchStart"
                bindtouchmove="onScrollTouchMove"
                bindtouchend="onScrollTouchEnd"
                bindscroll="onScroll"
              >
                <!-- 关联人物 -->
                <view class="info-section" wx:if="{{item.relatedCharacters && item.relatedCharacters.length}}">
                  <view class="section-header">
                    <text class="section-icon">👥</text>
                    <text class="section-title">关联人物</text>
                  </view>
                  <view class="characters-container">
                    <block wx:for="{{item.relatedCharacters}}" wx:key="index">
                      <text class="character-tag">{{item}}</text>
                    </block>
                  </view>
                </view>

                <!-- 故事片段 -->
                <view class="info-section" wx:if="{{item.storySegments && item.storySegments.length}}">
                  <view class="section-header">
                    <text class="section-icon">📖</text>
                    <text class="section-title">故事片段</text>
                  </view>
                  <view class="segments-container">
                    <block wx:for="{{item.storySegments}}" wx:key="index">
                      <view class="segment-item">
                        <text class="segment-number">{{index + 1}}.</text>
                        <text class="segment-text">{{item}}</text>
                      </view>
                    </block>
                  </view>
                </view>

                <!-- 完整故事 -->
                <view class="info-section" wx:if="{{item.story}}">
                  <view class="section-header">
                    <text class="section-icon">📚</text>
                    <text class="section-title">完整故事</text>
                  </view>
                  <text class="story-text">{{item.story}}</text>
                </view>

                <!-- 成语发生地 -->
                <view class="info-section" wx:if="{{item.scenicSpot || item.address}}">
                  <view class="section-header">
                    <text class="section-icon">📍</text>
                    <text class="section-title">成语发生地</text>
                  </view>
                  <view class="location-info">
                    <text class="location-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </view>

                <!-- 底部留白 -->
                <view class="bottom-padding"></view>
              </scroll-view>

              <!-- 滑动提示 -->
              <view class="swipe-hint" wx:if="{{showSwipeHint && currentIdioms.length > 1}}">
                <text class="hint-text">← 左右滑动切换成语 →</text>
              </view>
            </view>
          </swiper-item>
        </block>
      </swiper>
    </view>
  </view>
  <view wx:if="{{isLoading}}" class="loading-container">
    <text class="loading-text">加载中...</text>
  </view>
</view>

