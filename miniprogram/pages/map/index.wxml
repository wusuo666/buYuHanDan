<!-- åœ°å›¾å®¹å™¨ -->
<view class="map-container">
  <map 
    id="idiomMap" 
    class="map" 
    latitude="{{latitude}}"
    longitude="{{longitude}}"
    scale="{{scale}}"
    markers="{{markers}}"
    show-location
    bindmarkertap="onMarkerTap"
  >
    <cover-view class="controls-container">
      <cover-view class="control-item" bindtap="moveToHandan">
        <cover-image src="/images/location-icon.png" class="control-icon"></cover-image>
        <cover-text>å®šä½é‚¯éƒ¸</cover-text>
      </cover-view>
    </cover-view>
  </map>
  <view wx:if="{{showPopup}}" class="popup-mask" bindtap="closePopup">
    <view class="popup-swiper-container">
      <swiper 
        class="idiom-swiper"
        current="{{currentIdiomIndex}}" 
        bindchange="onSwiperChange"
        circular="{{false}}"
        duration="300"
        bindtouchstart="onSwiperTouchStart"
        bindtouchmove="onSwiperTouchMove"
        bindtouchend="onSwiperTouchEnd"
      >
        <block wx:for="{{currentIdioms}}" wx:key="index">
          <swiper-item>
            <view class="popup-content" catchtap="stopPropagation">
              <!-- å¼¹çª—å¤´éƒ¨ -->
              <view class="popup-header">
                <text class="idiom-title">{{item.name || 'æˆè¯­è¯¦æƒ…'}}</text>
                <view class="header-indicator">
                  <text class="indicator-text">{{currentIdiomIndex + 1}}/{{currentIdioms.length}}</text>
                  <view class="indicator-dots">
                    <block wx:for="{{currentIdioms}}" wx:key="index">
                      <view class="dot {{index === currentIdiomIndex ? 'active' : ''}}"></view>
                    </block>
                  </view>
                </view>
                <text class="close-btn" bindtap="closePopup">Ã—</text>
              </view>
              
              <!-- å›¾ç‰‡è½®æ’­åŒºåŸŸ -->
              <view class="image-carousel" wx:if="{{item.images && item.images.length}}">
                <swiper 
                  class="image-swiper" 
                  current="{{currentImageIndex}}" 
                  bindchange="onImageSwiperChange"
                  circular="{{true}}"
                  autoplay="{{true}}"
                  interval="3000"
                  duration="300"
                >
                  <block wx:for="{{item.images}}" wx:key="index">
                    <swiper-item>
                      <image class="carousel-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}"></image>
                    </swiper-item>
                  </block>
                </swiper>
                <view class="image-indicator" wx:if="{{item.images.length > 1}}">
                  <text class="image-indicator-text">{{currentImageIndex + 1}}/{{item.images.length}}</text>
                </view>
              </view>

              <!-- å†…å®¹åŒºåŸŸ - å¯ä¸Šä¸‹æ»šåŠ¨ -->
              <scroll-view 
                class="popup-body" 
                scroll-y 
                enhanced
                id="scroll-{{index}}"
                bindtouchstart="onScrollTouchStart"
                bindtouchmove="onScrollTouchMove"
                bindtouchend="onScrollTouchEnd"
                bindscroll="onScroll"
              >
                <!-- å…³è”äººç‰© -->
                <view class="info-section" wx:if="{{item.relatedCharacters && item.relatedCharacters.length}}">
                  <view class="section-header">
                    <text class="section-icon">ğŸ‘¥</text>
                    <text class="section-title">å…³è”äººç‰©</text>
                  </view>
                  <view class="characters-container">
                    <block wx:for="{{item.relatedCharacters}}" wx:key="index">
                      <text class="character-tag">{{item}}</text>
                    </block>
                  </view>
                </view>

                <!-- æ•…äº‹ç‰‡æ®µ -->
                <view class="info-section" wx:if="{{item.storySegments && item.storySegments.length}}">
                  <view class="section-header">
                    <text class="section-icon">ğŸ“–</text>
                    <text class="section-title">æ•…äº‹ç‰‡æ®µ</text>
                  </view>
                  <view class="segments-container">
                    <block wx:for="{{item.storySegments}}" wx:key="index">
                      <view class="segment-item">
                        <text class="segment-number">{{index + 1}}.</text>
                        <text class="segment-text">{{item}}</text>
                      </view>
                    </block>
                  </view>
                </view>

                <!-- å®Œæ•´æ•…äº‹ -->
                <view class="info-section" wx:if="{{item.story}}">
                  <view class="section-header">
                    <text class="section-icon">ğŸ“š</text>
                    <text class="section-title">å®Œæ•´æ•…äº‹</text>
                  </view>
                  <text class="story-text">{{item.story}}</text>
                </view>

                <!-- æˆè¯­å‘ç”Ÿåœ° -->
                <view class="info-section" wx:if="{{item.scenicSpot || item.address}}">
                  <view class="section-header">
                    <text class="section-icon">ğŸ“</text>
                    <text class="section-title">æˆè¯­å‘ç”Ÿåœ°</text>
                  </view>
                  <view class="location-info">
                    <text class="location-address" wx:if="{{item.address}}">{{item.address}}</text>
                  </view>
                </view>

                <!-- åº•éƒ¨ç•™ç™½ -->
                <view class="bottom-padding"></view>
              </scroll-view>

              <!-- æ»‘åŠ¨æç¤º -->
              <view class="swipe-hint" wx:if="{{showSwipeHint && currentIdioms.length > 1}}">
                <text class="hint-text">â† å·¦å³æ»‘åŠ¨åˆ‡æ¢æˆè¯­ â†’</text>
              </view>
            </view>
          </swiper-item>
        </block>
      </swiper>
    </view>
  </view>
  <view wx:if="{{isLoading}}" class="loading-container">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

