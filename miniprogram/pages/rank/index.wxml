<!-- pages/rank/index.wxml -->
<view class="container">
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 'friend' ? 'active' : ''}}"
      data-tab="friend"
      bindtap="switchTab"
    >
      å¥½å‹æ’è¡Œ
    </view>
    <view 
      class="tab-item {{currentTab === 'global' ? 'active' : ''}}"
      data-tab="global"
      bindtap="switchTab"
    >
      å…¨çƒæ’è¡Œ
    </view>
  </view>

  <!-- æˆ‘çš„æ’åå¡ç‰‡ - å§‹ç»ˆæ˜¾ç¤º -->
  <view class="my-rank-card">
    <view class="my-rank-content">
      <image 
        class="my-avatar" 
        src="{{myRankInfo.avatar || '/images/avatar.png'}}"
        mode="aspectFill"
      />
      <view class="my-info">
        <view class="my-nickname">
          {{myRankInfo.nickname || 'æ¸¸å®¢'}}
          <text class="guest-tip" wx:if="{{!userInfo}}">(æœªç™»å½•)</text>
        </view>
        <view class="my-stats">
          <text class="stat-item">æ’å: {{myRankInfo.rank || '--'}}</text>
          <text class="stat-item">å¾—åˆ†: {{myRankInfo.score || 0}}</text>
          <text class="stat-item">å…³å¡: {{myRankInfo.level || 0}}</text>
        </view>
      </view>
      <!-- å¯é€‰çš„ç™»å½•æŒ‰é’® -->
      <button wx:if="{{!userInfo}}" class="login-btn-small" bindtap="getUserProfile">
        ç™»å½•
      </button>
    </view>
    <view class="action-buttons">
      <button class="share-btn" bindtap="generatePoster">
        <text class="iconfont icon-poster">ğŸ“·</text>
        ç”Ÿæˆæµ·æŠ¥
      </button>
      <button class="share-btn" open-type="share">
        <text class="iconfont icon-share">ğŸ“¤</text>
        åˆ†äº«å¥½å‹
      </button>
      <button class="share-btn timeline-btn" bindtap="shareToTimeline">
        <text class="iconfont icon-timeline">ğŸŒ</text>
        æœ‹å‹åœˆ
      </button>
    </view>
  </view>

  <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
  <scroll-view 
    class="rank-list"
    scroll-y
    enable-back-to-top
    bindscrolltolower="onReachBottom"
  >
    <!-- æ’è¡Œæ¦œé¡¹ç›® -->
    <view class="rank-item" wx:for="{{rankList}}" wx:key="_id">
      <!-- æ’åæ ‡è¯† -->
      <view class="rank-number {{item.rank <= 3 ? 'top-' + item.rank : ''}}">
        <text wx:if="{{item.rank <= 3}}" class="medal">{{item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}}</text>
        <text wx:else>{{item.rank}}</text>
      </view>
      
      <!-- ç”¨æˆ·å¤´åƒ -->
      <image 
        class="user-avatar" 
        src="{{item.avatar || '/images/avatar.png'}}"
        mode="aspectFill"
      />
      
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info">
        <view class="user-nickname">
          {{item.nickname || 'æ¸¸å®¢'}}
          <text class="tag-me" wx:if="{{item.isMe}}">æˆ‘</text>
        </view>
        <view class="user-progress">
          <text class="progress-item">{{item.score || 0}}åˆ†</text>
          <text class="progress-item">ç¬¬{{item.level || 0}}å…³</text>
          <text class="progress-item" wx:if="{{item.unlockedSpots}}">{{item.unlockedSpots.length}}ä¸ªæ™¯ç‚¹</text>
        </view>
      </view>
      
      <!-- åˆ†æ•° -->
      <view class="score-display">
        <text class="score-number">{{item.score || 0}}</text>
        <text class="score-label">åˆ†</text>
      </view>
    </view>

    <!-- åŠ è½½æç¤º -->
    <view class="loading-tip" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more-tip" wx:if="{{!hasMore && rankList.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ - åªåœ¨æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤º -->
    <view class="empty-state" wx:if="{{!loading && rankList.length === 0}}">
      <view class="empty-icon">ğŸ“Š</view>
      <image class="empty-icon" src="/images/empty.png" mode="aspectFit" />
      <text class="empty-text">æš‚æ— æ’è¡Œæ•°æ®</text>
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-text">æš‚æ— æ›´å¤šæ’è¡Œæ•°æ®</text>
      <text class="empty-sub">å¿«å»æ¸¸æˆä¸­åˆ›é€ ä½ çš„è®°å½•å§ï¼</text>
      <navigator url="/pages/game/index" open-type="switchTab">
        <button class="go-game-btn">å¼€å§‹æ¸¸æˆ</button>
      </navigator>
    </view>
  </scroll-view>

  <!-- æµ·æŠ¥å¼¹çª— -->
  <view class="poster-modal" wx:if="{{showPoster}}" bindtap="closePoster">
    <view class="poster-container" catchtap="doNothing">
      <image class="poster-image" src="{{posterUrl}}" mode="aspectFit" />
      <view class="poster-actions">
        <button class="poster-btn save-btn" bindtap="savePoster">ä¿å­˜åˆ°ç›¸å†Œ</button>
        <button class="poster-btn cancel-btn" bindtap="closePoster">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <!-- Canvasç”¨äºç”Ÿæˆæµ·æŠ¥ -->
  <canvas 
    type="2d" 
    id="posterCanvas" 
    class="poster-canvas"
    style="width: 375px; height: 667px; position: fixed; left: -9999px;"
  />
</view>