<!-- pages/rank/index.wxml -->
<view class="container">
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 'friend' ? 'active' : ''}}"
      data-tab="friend"
      bindtap="switchTab"
    >
      å¥½å‹æ’è¡Œ
    </view>
    <view 
      class="tab-item {{currentTab === 'global' ? 'active' : ''}}"
      data-tab="global"
      bindtap="switchTab"
    >
      å…¨çƒæ’è¡Œ
    </view>
  </view>

  <!-- æˆ‘çš„æ’åå¡ç‰‡ -->
  <view class="my-rank-card" wx:if="{{myRankInfo}}">
    <view class="my-rank-content">
      <image 
        class="my-avatar" 
        src="{{myRankInfo.avatar || '/images/avatar.png'}}"
        mode="aspectFill"
      />
      <view class="my-info">
        <view class="my-nickname">{{myRankInfo.nickname || 'æ¸¸å®¢'}}</view>
        <view class="my-stats">
          <text class="stat-item">æ’å: {{myRankInfo.rank || '--'}}</text>
          <text class="stat-item">å¾—åˆ†: {{myRankInfo.score || 0}}</text>
          <text class="stat-item">å…³å¡: {{myRankInfo.level || 0}}</text>
        </view>
        <view class="my-progress" wx:if="{{userStats}}">
          <text class="progress-text">å·²è§£é” {{(userStats.unlockedSpots || []).length}}/{{userStats.totalSpots || 0}} ä¸ªæ™¯ç‚¹</text>
        </view>
      </view>
    </view>
    <view class="action-buttons">
      <button class="share-btn poster-btn" bindtap="generatePoster">
        <text class="iconfont">ğŸ“·</text>
        ç”Ÿæˆæµ·æŠ¥
      </button>
      <button class="share-btn invite-btn" bindtap="showInviteModal">
        <text class="iconfont">ğŸ‘¥</text>
        é‚€è¯·å¥½å‹
      </button>
      <button class="share-btn" open-type="share">
        <text class="iconfont">ğŸ“¤</text>
        åˆ†äº«å¥½å‹
      </button>
    </view>
  </view>

  <!-- æœªæˆæƒæç¤º -->
  <view class="auth-tip" wx:if="{{!hasUserInfo}}">
    <text class="tip-text">æˆæƒåå¯æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ</text>
    <button class="auth-btn" bindtap="getUserProfile">ç«‹å³æˆæƒ</button>
  </view>

  <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
  <scroll-view 
    class="rank-list"
    scroll-y
    enable-back-to-top
    bindscrolltolower="onReachBottom"
  >
    <view class="rank-item" wx:for="{{rankList}}" wx:key="_id">
      <!-- æ’åæ ‡è¯† -->
      <view class="rank-number {{item.rank <= 3 ? 'top-' + item.rank : ''}}">
        <text wx:if="{{item.rank <= 3}}" class="medal">{{item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}}</text>
        <text wx:else>{{item.rank}}</text>
      </view>
      
      <!-- ç”¨æˆ·å¤´åƒ -->
      <image 
        class="user-avatar" 
        src="{{item.avatar || '/images/avatar.png'}}"
        mode="aspectFill"
      />
      
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info">
        <view class="user-nickname">
          {{item.nickname || 'æ¸¸å®¢'}}
          <text class="tag-me" wx:if="{{item.isMe}}">æˆ‘</text>
        </view>
        <view class="user-progress">
          <text class="progress-item">{{item.score || 0}}åˆ†</text>
          <text class="progress-item">ç¬¬{{item.level || 0}}å…³</text>
          <text class="progress-item" wx:if="{{item.unlockedSpots}}">{{(item.unlockedSpots || []).length}}ä¸ªæ™¯ç‚¹</text>
        </view>
      </view>
      
      <!-- åˆ†æ•° -->
      <view class="score-display">
        <text class="score-number">{{item.score || 0}}</text>
        <text class="score-label">åˆ†</text>
      </view>
    </view>

    <!-- åŠ è½½æç¤º -->
    <view class="loading-tip" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more-tip" wx:if="{{!hasMore && rankList.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && rankList.length === 0}}">
      <image class="empty-icon" src="/images/avatar.png" mode="aspectFit" />
      <text class="empty-text">æš‚æ— æ’è¡Œæ•°æ®</text>
      <text class="empty-sub">å¿«å»æ¸¸æˆä¸­åˆ›é€ ä½ çš„è®°å½•å§ï¼</text>
      <navigator url="/pages/game/index" open-type="switchTab">
        <button class="go-game-btn">å¼€å§‹æ¸¸æˆ</button>
      </navigator>
    </view>
  </scroll-view>

  <!-- é‚€è¯·å¼¹çª— -->
  <view class="invite-modal" wx:if="{{showInviteModal}}" bindtap="closeInviteModal">
    <view class="invite-container" catchtap="doNothing">
      <view class="invite-header">
        <text class="invite-title">é‚€è¯·å¥½å‹</text>
        <text class="invite-subtitle">ä¸€èµ·è§£é”é‚¯éƒ¸æˆè¯­æ•…äº‹</text>
      </view>
      <view class="invite-content">
        <text class="invite-message">{{inviteMessage}}</text>
        <view class="invite-features">
          <view class="feature-item">
            <text class="feature-icon">ğŸ¯</text>
            <text class="feature-text">æŒ‘æˆ˜æˆè¯­å…³å¡</text>
          </view>
          <view class="feature-item">
            <text class="feature-icon">ğŸ—ºï¸</text>
            <text class="feature-text">æ¢ç´¢é‚¯éƒ¸æ™¯ç‚¹</text>
          </view>
          <view class="feature-item">
            <text class="feature-icon">ğŸ†</text>
            <text class="feature-text">æ¯”æ‹¼æ’è¡Œæ¦œ</text>
          </view>
        </view>
      </view>
      <view class="invite-actions">
        <button class="invite-btn primary" bindtap="sendInvitation">å‘é€é‚€è¯·</button>
        <button class="invite-btn secondary" bindtap="closeInviteModal">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <!-- æµ·æŠ¥å¼¹çª— -->
  <view class="poster-modal" wx:if="{{showPoster}}" bindtap="closePoster">
    <view class="poster-container" catchtap="doNothing">
      <image class="poster-image" src="{{posterUrl}}" mode="aspectFit" />
      <view class="poster-actions">
        <button class="poster-btn save-btn" bindtap="savePoster">ä¿å­˜åˆ°ç›¸å†Œ</button>
        <button class="poster-btn cancel-btn" bindtap="closePoster">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <!-- Canvasç”¨äºç”Ÿæˆæµ·æŠ¥ -->
  <canvas 
    type="2d" 
    id="posterCanvas" 
    class="poster-canvas"
    style="width: 375px; height: 667px; position: fixed; left: -9999px;"
  />
</view>