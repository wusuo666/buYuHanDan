# 邯郸成语导览 - 社交互动模块

## 功能概述

本模块为邯郸成语导览小程序增加了完整的社交互动功能，包括好友排行榜、分享海报、邀请好友等核心功能。

## 核心功能

### 1. 好友排行榜
- **功能描述**: 显示微信好友的游戏通关数排名
- **实现方式**: 通过云函数获取好友数据并排序
- **数据来源**: 云数据库 `progress` 集合
- **显示内容**: 排名、头像、昵称、得分、关卡数、解锁景点数

### 2. 分享功能
- **功能描述**: 生成"我的成语进度"海报，包含通关量+已解锁景点地图
- **技术实现**: 使用Canvas绘制固定模板+用户数据
- **海报内容**: 
  - 用户头像和昵称
  - 排名信息（排名/总人数）
  - 游戏数据（得分、关卡、解锁景点）
  - 已解锁景点列表
  - 引导文案"一起解锁邯郸成语故事"
- **保存方式**: 可保存到手机相册

### 3. 邀请功能
- **功能描述**: 发送小程序卡片给好友，附带"一起解锁邯郸成语故事"文案
- **邀请内容**: 
  - 挑战成语关卡
  - 探索邯郸景点
  - 比拼排行榜
- **记录方式**: 云数据库记录邀请关系

### 4. 游戏页面分享
- **功能描述**: 在游戏页面直接分享游戏进度
- **分享内容**: 当前通关数、游戏模式选择
- **分享方式**: 微信好友、朋友圈

## 技术架构

### 前端实现
- **排行榜页面**: `miniprogram/pages/rank/`
  - `index.js`: 业务逻辑，包含数据获取、海报生成、邀请功能
  - `index.wxml`: 页面结构，包含排行榜列表、邀请弹窗、海报弹窗
  - `index.wxss`: 页面样式，包含响应式布局、动画效果

- **游戏页面**: `miniprogram/pages/game/`
  - `index.js`: 游戏逻辑，包含用户进度、分享功能
  - `index.wxml`: 游戏界面，包含用户信息卡片、游戏选择、统计信息
  - `index.wxss`: 游戏样式，包含卡片布局、按钮样式

### 后端实现
- **云函数**: `cloudfunctions/rank/`
  - `index.js`: 云函数入口，包含所有数据操作接口
  - `package.json`: 依赖管理

### 数据库设计
- **progress集合**: 用户进度数据
  ```json
  {
    "_openid": "用户openid",
    "nickname": "用户昵称",
    "avatar": "头像URL",
    "level": "通关数",
    "score": "得分",
    "unlockedSpots": [
      {
        "spotId": "景点ID",
        "spotName": "景点名称",
        "idiomId": "成语ID",
        "unlockTime": "解锁时间"
      }
    ],
    "createTime": "创建时间",
    "lastUpdateTime": "最后更新时间"
  }
  ```

- **invitations集合**: 邀请记录
  ```json
  {
    "inviterOpenid": "邀请者openid",
    "inviteeOpenid": "被邀请者openid",
    "inviterNickname": "邀请者昵称",
    "createTime": "邀请时间",
    "status": "状态(pending/accepted/declined)"
  }
  ```

## 使用方法

### 1. 部署云函数
```bash
cd cloudfunctions/rank
npm install
# 在微信开发者工具中右键云函数，选择"上传并部署"
```

### 2. 配置小程序
- 确保小程序已开通云开发功能
- 配置云开发环境ID
- 创建必要的数据库集合

### 3. 功能测试
- **排行榜**: 进入排行榜页面，查看好友排行和全球排行
- **分享海报**: 点击"生成海报"按钮，生成并保存分享海报
- **邀请好友**: 点击"邀请好友"按钮，发送邀请
- **游戏分享**: 在游戏页面点击分享按钮，分享游戏进度

## 注意事项

### 1. 微信限制
- 微信小程序无法直接获取好友openid列表
- 当前实现使用当前用户数据作为"好友"数据（演示用）
- 实际项目中需要通过其他方式获取好友关系

### 2. 权限要求
- 需要用户授权获取头像和昵称
- 保存海报需要相册权限
- 分享功能需要微信分享权限

### 3. 性能优化
- 排行榜数据支持分页加载
- 海报生成使用Canvas优化
- 用户数据缓存减少云函数调用

## 扩展功能

### 1. 好友系统
- 实现真实的好友关系链
- 添加好友申请和确认流程
- 好友间游戏数据对比

### 2. 成就系统
- 解锁特定景点获得成就徽章
- 连续通关获得连击奖励
- 分享次数达到目标获得特殊称号

### 3. 社交活动
- 成语接龙挑战
- 景点打卡签到
- 成语知识竞赛

## 故障排除

### 1. 常见问题
- **海报生成失败**: 检查Canvas权限和图片资源
- **排行榜加载失败**: 检查云函数部署和数据库权限
- **分享功能异常**: 检查微信分享配置

### 2. 调试方法
- 查看云函数日志
- 检查小程序控制台错误
- 验证数据库集合结构

## 更新日志

- **v1.0.0**: 基础社交功能实现
  - 好友排行榜
  - 分享海报生成
  - 邀请功能
  - 游戏页面分享

## 联系方式

如有问题或建议，请联系开发团队。 